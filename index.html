<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Casa do Banner Painel de Pedidos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { background-color: #f3f4f6; padding: 30px; font-family: 'Roboto', sans-serif; }
    h1 { color: #003366; margin-bottom: 30px; font-size: 36px; font-weight: bold; text-align: center; }
    .btn-primary { background-color: #ffcc00; border-color: #ffcc00; color: #003366; font-weight: bold; }
    .btn-primary:hover { background-color: #ffb800; border-color: #ffb800; }
    .btn-outline-secondary { color: #00bcd4; border-color: #00bcd4; font-weight: bold; }
    .btn-outline-secondary:hover { background-color: #00bcd4; color: white; }
    .btn-outline-danger { color: #f50057; border-color: #f50057; font-weight: bold; }
    .btn-outline-danger:hover { background-color: #f50057; color: white; }
    .status-Concluído { color: #2ecc71; font-weight: bold; }
    .status-Pendente { color: #e74c3c; font-weight: bold; }
    .status-Em_andamento { color: #f39c12; font-weight: bold; }
    .status-Criação_de_Arte { color: #9b59b6; font-weight: bold; }
    .status-Arte_Aprovada { color: #2980b9; font-weight: bold; }
    .status-Em_Produção { color: #16a085; font-weight: bold; }
    table { background-color: #ffffff; border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    table thead th { cursor: pointer; background-color: #003366; color: white; border-radius: 8px 8px 0 0; padding: 12px; }
    table th, table td { padding: 12px; text-align: center; }
    table td { background-color: #f9f9f9; border-bottom: 1px solid #ddd; }
    table tbody tr:hover { background-color: #f1f1f1; cursor: pointer; }
    .modal-content { border-radius: 8px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
    .modal-header { background-color: #003366; color: white; border-radius: 8px 8px 0 0; }
    .modal-footer button { font-weight: bold; }
  </style>
</head>
<body>

<div class="container-fluid">
  <h1 class="text-center">Casa do Banner Painel de Pedidos</h1>

  <div class="d-flex justify-content-between mb-3">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#pedidoModal" onclick="novoPedido()">Novo Pedido</button>
    <div>
      <button class="btn btn-outline-secondary me-2" onclick="exportarCSV()">Exportar CSV</button>
      <button class="btn btn-outline-danger" onclick="exportarPDF()">Exportar PDF</button>
    </div>
  </div>

  <table class="table table-striped">
    <thead>
      <tr>
        <th onclick="ordenar('Nome')">Nome</th>
        <th>ID Pedido</th>
        <th>Local</th>
        <th onclick="ordenar('Data Pedido')">Data Pedido</th>
        <th>Prazo Entrega</th>
        <th>Quantidade</th>
        <th>Produto</th>
        <th onclick="ordenar('Status')">Status</th>
        <th>Prioridade</th>
        <th>Observação</th>
        <th>Ações</th>
      </tr>
      <tr>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" placeholder="Buscar..." /></th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th>
          <select class="form-select form-select-sm" onchange="filtrarTabela()">
            <option value="">Todos</option>
            <option value="Pedidos Rua">Pedidos Rua</option>
            <option value="Pedidos Shopee">Pedidos Shopee</option>
          </select>
        </th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th>
          <select class="form-select form-select-sm" onchange="filtrarTabela()">
            <option value="">Todos</option>
            <option value="Não">Não</option>
            <option value="Sim">Sim</option>
          </select>
        </th>
        <th><input class="form-control form-control-sm" oninput="filtrarTabela()" /></th>
        <th></th>
      </tr>
    </thead>
    <tbody id="tabelaPedidos"></tbody>
  </table>
</div>

<!-- Modal -->
<div class="modal fade" id="pedidoModal" tabindex="-1" aria-labelledby="pedidoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="pedidoForm" class="modal-content">
      <input type="hidden" id="index" />
      <div class="modal-header">
        <h5 class="modal-title" id="pedidoModalLabel">Novo Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label for="usuario" class="form-label">Nome</label>
            <input type="text" id="usuario" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label for="idPedido" class="form-label">ID do Pedido</label>
            <input type="text" id="idPedido" class="form-control" required />
          </div>
          <div class="col-md-3">
            <label for="local" class="form-label">Local</label>
            <select id="local" class="form-select" required>
              <option value="Pedidos Rua">Pedidos Rua</option>
              <option value="Pedidos Shopee">Pedidos Shopee</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="data" class="form-label">Data Pedido</label>
            <input type="date" id="data" class="form-control" required />
          </div>
          <div class="col-md-4">
            <label for="prazo" class="form-label">Prazo Entrega</label>
            <input type="date" id="prazo" class="form-control" />
          </div>
          <div class="col-md-2">
            <label for="quantidade" class="form-label">Quantidade</label>
            <input type="number" id="quantidade" class="form-control" required />
          </div>
          <div class="col-md-6">
            <label for="produto" class="form-label">Produto</label>
            <select id="produto" class="form-select" required>
              <option value="">Carregando...</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="status" class="form-label">Status</label>
            <select id="status" class="form-select" required>
              <option value="Pendente">Pendente</option>
              <option value="Em andamento">Em andamento</option>
              <option value="Criação de Arte">Criação de Arte</option>
              <option value="Arte Aprovada">Arte Aprovada</option>
              <option value="Em Produção">Em Produção</option>
              <option value="Concluído">Concluído</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="prioridade" class="form-label">Prioridade</label>
            <select id="prioridade" class="form-select">
              <option value="Não">Não</option>
              <option value="Sim">Sim</option>
            </select>
          </div>
          <div class="col-12">
            <label for="observacao" class="form-label">Observação</label>
            <textarea id="observacao" class="form-control" rows="3" placeholder="Informações complementares"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="submit" class="btn btn-primary">Salvar Pedido</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
  const API_URL = 'https://script.google.com/macros/s/AKfycbx1pXz1Dxk-H5ul81_QfGce0cCA0tpGGwNLMi95R9AaQfPoJ6UKIr604Tq3H-ewzvMh2A/exec';
  let pedidos = [];
  let produtos = [];
  let modal;

  document.addEventListener('DOMContentLoaded', () => {
    modal = new bootstrap.Modal(document.getElementById('pedidoModal'));
    carregarPedidos();
  });

  async function carregarPedidos() {
    try {
      const res = await fetch(API_URL);
      pedidos = await res.json();
      renderizarTabela(pedidos);
    } catch (err) {
      alert('Erro ao carregar pedidos.');
      console.error(err);
    }
  }

  async function carregarProdutos() {
    try {
      const res = await fetch(`${API_URL}?tipo=produtos`);
      produtos = await res.json();
      const selectProduto = document.getElementById('produto');
      selectProduto.innerHTML = '<option value="">Selecione um produto</option>';
      produtos.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p;
        opt.textContent = p;
        selectProduto.appendChild(opt);
      });
    } catch (err) {
      console.error('Erro ao carregar produtos:', err);
      document.getElementById('produto').innerHTML = '<option value="">Erro ao carregar</option>';
    }
  }

  async function novoPedido() {
    document.getElementById('pedidoForm').reset();
    document.getElementById('index').value = '';
    document.getElementById('pedidoModalLabel').textContent = 'Novo Pedido';
    await carregarProdutos();
    modal.show();
  }

  function renderizarTabela(lista) {
    const tbody = document.getElementById('tabelaPedidos');
    tbody.innerHTML = '';
    lista.forEach((p, i) => {
      const dataPedido = p['Data Pedido'] ? new Date(p['Data Pedido']).toLocaleDateString('pt-BR') : '';
      const prazoEntrega = p['Prazo Entrega'] ? new Date(p['Prazo Entrega']).toLocaleDateString('pt-BR') : '';
      const statusClass = p['Status'] ? 'status-' + p['Status'].replace(/ /g, '_') : '';
      const obs = p['Observação'] || '';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${p['Nome'] || ''}</td>
        <td>${p['ID Pedido'] || ''}</td>
        <td>${p['Local'] || ''}</td>
        <td>${dataPedido}</td>
        <td>${prazoEntrega}</td>
        <td>${p['Quantidade'] || ''}</td>
        <td>${p['Produto'] || ''}</td>
        <td class="${statusClass}">${p['Status'] || ''}</td>
        <td>${p['Prioridade'] || ''}</td>
        <td>${obs}</td>
        <td>
          <button class="btn btn-sm btn-outline-secondary me-2" onclick="editarPedido(${i})">Editar</button>
          <button class="btn btn-sm btn-outline-danger" onclick="excluirPedido(${i})">Excluir</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function filtrarTabela() {
    const tbody = document.getElementById('tabelaPedidos');
    const filtros = Array.from(document.querySelectorAll('thead tr:nth-child(2) input, thead tr:nth-child(2) select'));
    const valoresFiltro = filtros.map(f => f.value.trim().toLowerCase());

    const listaFiltrada = pedidos.filter(p => {
      return (
        (p['Nome'] || '').toLowerCase().includes(valoresFiltro[0]) &&
        (p['ID Pedido'] || '').toLowerCase().includes(valoresFiltro[1]) &&
        (p['Local'] || '').toLowerCase().includes(valoresFiltro[2]) &&
        (p['Data Pedido'] || '').toLowerCase().includes(valoresFiltro[3]) &&
        (p['Prazo Entrega'] || '').toLowerCase().includes(valoresFiltro[4]) &&
        (String(p['Quantidade'] || '')).toLowerCase().includes(valoresFiltro[5]) &&
        (p['Produto'] || '').toLowerCase().includes(valoresFiltro[6]) &&
        (p['Status'] || '').toLowerCase().includes(valoresFiltro[7]) &&
        (p['Prioridade'] || '').toLowerCase().includes(valoresFiltro[8]) &&
        (p['Observação'] || '').toLowerCase().includes(valoresFiltro[9])
      );
    });
    renderizarTabela(listaFiltrada);
  }

document.getElementById('pedidoForm').addEventListener('submit', async e => {
  e.preventDefault();
  const index = document.getElementById('index').value;
  const pedido = {
    'Nome': document.getElementById('usuario').value.trim(),
    'ID Pedido': document.getElementById('idPedido').value.trim(),
    'Local': document.getElementById('local').value,
    'Data Pedido': document.getElementById('data').value,
    'Prazo Entrega': document.getElementById('prazo').value,
    'Quantidade': document.getElementById('quantidade').value,
    'Produto': document.getElementById('produto').value,
    'Status': document.getElementById('status').value,
    'Prioridade': document.getElementById('prioridade').value,
    'Observação': document.getElementById('observacao').value.trim(),
  };

  try {
    let res;
    if (index === '') {
      // Inserir novo pedido
      res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(pedido)
      });
    } else {
      // Atualizar pedido
      pedido.index = parseInt(index);
      res = await fetch(API_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'text/plain;charset=utf-8' },
        body: JSON.stringify(pedido)
      });
    }

    if (!res.ok) throw new Error('Erro ao salvar pedido.');

    await carregarPedidos();
    modal.hide();
  } catch (err) {
    alert(err.message);
    console.error(err);
  }
});

  function editarPedido(i) {
    const pedido = pedidos[i];
    document.getElementById('pedidoModalLabel').textContent = 'Editar Pedido';
    document.getElementById('index').value = i;
    document.getElementById('usuario').value = pedido['Nome'] || '';
    document.getElementById('idPedido').value = pedido['ID Pedido'] || '';
    document.getElementById('local').value = pedido['Local'] || '';
    document.getElementById('data').value = pedido['Data Pedido'] || '';
    document.getElementById('prazo').value = pedido['Prazo Entrega'] || '';
    document.getElementById('quantidade').value = pedido['Quantidade'] || '';
    carregarProdutos().then(() => {
      document.getElementById('produto').value = pedido['Produto'] || '';
    });
    document.getElementById('status').value = pedido['Status'] || '';
    document.getElementById('prioridade').value = pedido['Prioridade'] || 'Não';
    document.getElementById('observacao').value = pedido['Observação'] || '';
    modal.show();
  }

  async function excluirPedido(i) {
  if (!confirm('Deseja realmente excluir este pedido?')) return;
  try {
    const res = await fetch(API_URL, {
      method: 'DELETE',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify({ idPedido: pedidos[i]['ID Pedido'] })
    });
    if (!res.ok) throw new Error('Erro ao excluir pedido.');
    await carregarPedidos();
  } catch (err) {
    alert(err.message);
    console.error(err);
  }
}
  let ordemAtual = { coluna: '', direcao: 'asc' };
  function ordenar(coluna) {
    if (ordemAtual.coluna === coluna) {
      ordemAtual.direcao = ordemAtual.direcao === 'asc' ? 'desc' : 'asc';
    } else {
      ordemAtual.coluna = coluna;
      ordemAtual.direcao = 'asc';
    }
    pedidos.sort((a, b) => {
      let valA = a[coluna] || '';
      let valB = b[coluna] || '';

      // Se for data, converte para Date
      if (coluna === 'Data Pedido' || coluna === 'Prazo Entrega') {
        valA = valA ? new Date(valA) : new Date(0);
        valB = valB ? new Date(valB) : new Date(0);
      } else {
        valA = valA.toString().toLowerCase();
        valB = valB.toString().toLowerCase();
      }

      if (valA < valB) return ordemAtual.direcao === 'asc' ? -1 : 1;
      if (valA > valB) return ordemAtual.direcao === 'asc' ? 1 : -1;
      return 0;
    });
    renderizarTabela(pedidos);
  }

  function exportarCSV() {
    let csv = 'Nome,ID Pedido,Local,Data Pedido,Prazo Entrega,Quantidade,Produto,Status,Prioridade,Observação\n';
    pedidos.forEach(p => {
      const dataPedido = p['Data Pedido'] ? new Date(p['Data Pedido']).toLocaleDateString('pt-BR') : '';
      const prazoEntrega = p['Prazo Entrega'] ? new Date(p['Prazo Entrega']).toLocaleDateString('pt-BR') : '';
      const linha = [
        p['Nome'] || '',
        p['ID Pedido'] || '',
        p['Local'] || '',
        dataPedido,
        prazoEntrega,
        p['Quantidade'] || '',
        p['Produto'] || '',
        p['Status'] || '',
        p['Prioridade'] || '',
        (p['Observação'] || '').replace(/(\r\n|\n|\r)/gm, " ")  // remove quebras de linha
      ].map(v => `"${v.toString().replace(/"/g, '""')}"`).join(',');
      csv += linha + '\n';
    });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'pedidos.csv';
    a.click();
    URL.revokeObjectURL(url);
  }

  function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18);
    doc.text('Casa do Banner - Painel de Pedidos', 10, 20);
    doc.setFontSize(11);

    const colunas = ['Nome', 'ID Pedido', 'Local', 'Data Pedido', 'Prazo Entrega', 'Quantidade', 'Produto', 'Status', 'Prioridade', 'Observação'];
    const linhas = pedidos.map(p => [
      p['Nome'] || '',
      p['ID Pedido'] || '',
      p['Local'] || '',
      p['Data Pedido'] ? new Date(p['Data Pedido']).toLocaleDateString('pt-BR') : '',
      p['Prazo Entrega'] ? new Date(p['Prazo Entrega']).toLocaleDateString('pt-BR') : '',
      p['Quantidade'] || '',
      p['Produto'] || '',
      p['Status'] || '',
      p['Prioridade'] || '',
      (p['Observação'] || '').replace(/(\r\n|\n|\r)/gm, " ")
    ]);

    // Usa autoTable se disponível para tabelas (opcional)
    if (doc.autoTable) {
      doc.autoTable({
        head: [colunas],
        body: linhas,
        startY: 30,
        styles: { fontSize: 8 },
        headStyles: { fillColor: [0, 51, 102], textColor: 255 },
      });
    } else {
      // Caso autoTable não esteja disponível, insere simples texto
      let y = 30;
      doc.text(colunas.join(' | '), 10, y);
      y += 10;
      linhas.forEach(linha => {
        doc.text(linha.join(' | '), 10, y);
        y += 10;
      });
    }
    doc.save('pedidos.pdf');
  }
</script>

</body>
</html>


